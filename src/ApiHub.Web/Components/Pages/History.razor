@page "/history"

<PageTitle>Request History - ApiHub</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Request History</h4>
    <div>
        <button class="btn btn-outline-primary me-2">
            <i class="bi bi-download me-1"></i> Export
        </button>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Connector</label>
                <select class="form-select" @bind="_connectorFilter">
                    <option value="">All Connectors</option>
                    @foreach (var connector in _connectors)
                    {
                        <option value="@connector">@connector</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Method</label>
                <select class="form-select" @bind="_methodFilter">
                    <option value="">All Methods</option>
                    <option>GET</option>
                    <option>POST</option>
                    <option>PUT</option>
                    <option>PATCH</option>
                    <option>DELETE</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="_statusFilter">
                    <option value="">All Statuses</option>
                    <option value="success">Success (2xx)</option>
                    <option value="redirect">Redirect (3xx)</option>
                    <option value="client-error">Client Error (4xx)</option>
                    <option value="server-error">Server Error (5xx)</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Range</label>
                <input type="date" class="form-control" @bind="_dateFilter" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Search</label>
                <input type="text" class="form-control" placeholder="URL or ID..."
                       @bind="_searchTerm" />
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Time</th>
                    <th>Connector</th>
                    <th>Method</th>
                    <th>URL</th>
                    <th>Status</th>
                    <th>Duration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var record in _records)
                {
                    <tr>
                        <td>
                            <small>@record.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</small>
                        </td>
                        <td>@record.Connector</td>
                        <td>
                            <span class="badge @GetMethodBadgeClass(record.Method)">@record.Method</span>
                        </td>
                        <td>
                            <code class="text-truncate d-inline-block" style="max-width: 300px;">
                                @record.Url
                            </code>
                        </td>
                        <td>
                            <span class="badge @(record.StatusCode < 400 ? "bg-success" : "bg-danger")">
                                @record.StatusCode
                            </span>
                        </td>
                        <td>@record.DurationMs ms</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" title="Replay">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="card-footer">
        <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
        </nav>
    </div>
</div>

@code {
    private string _connectorFilter = "";
    private string _methodFilter = "";
    private string _statusFilter = "";
    private DateTime? _dateFilter;
    private string _searchTerm = "";

    private List<string> _connectors = new() { "JSONPlaceholder", "Petstore", "ReqRes", "GitHub API", "OpenWeather" };

    private List<RequestRecord> _records = new()
    {
        new(DateTime.Now.AddMinutes(-5), "JSONPlaceholder", "GET", "/posts", 200, 123, true),
        new(DateTime.Now.AddMinutes(-10), "Petstore", "POST", "/pet", 201, 234, true),
        new(DateTime.Now.AddMinutes(-15), "ReqRes", "GET", "/users?page=2", 200, 156, true),
        new(DateTime.Now.AddMinutes(-20), "GitHub API", "GET", "/user/repos", 401, 89, false),
        new(DateTime.Now.AddMinutes(-25), "OpenWeather", "GET", "/weather?q=London", 200, 312, true),
        new(DateTime.Now.AddMinutes(-30), "JSONPlaceholder", "DELETE", "/posts/1", 200, 98, true),
        new(DateTime.Now.AddMinutes(-35), "Petstore", "GET", "/pet/findByStatus?status=available", 200, 445, true),
        new(DateTime.Now.AddMinutes(-40), "ReqRes", "PUT", "/users/2", 200, 167, true)
    };

    private string GetMethodBadgeClass(string method) => method switch
    {
        "GET" => "bg-primary",
        "POST" => "bg-success",
        "PUT" => "bg-warning text-dark",
        "PATCH" => "bg-info",
        "DELETE" => "bg-danger",
        _ => "bg-secondary"
    };

    private record RequestRecord(DateTime Timestamp, string Connector, string Method, string Url, int StatusCode, int DurationMs, bool IsSuccess);
}

@page "/api-runner"
@inject ApiHub.Web.Services.ApiRunnerStateService ApiRunnerState
@implements IDisposable

<PageTitle>API Runner - ApiHub</PageTitle>

@if (_fromTemplate)
{
    <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
        <i class="bi bi-file-earmark-code me-2"></i>
        <strong>Template loaded!</strong> The form has been populated from your selected template. Modify as needed and send your request.
        <button type="button" class="btn-close" @onclick="DismissTemplateAlert"></button>
    </div>
}

<div class="row g-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Request</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Connector</label>
                    <select class="form-select" @bind="_selectedConnector">
                        <option value="">Select a connector...</option>
                        @foreach (var connector in _connectors)
                        {
                            <option value="@connector.Id">@connector.Name</option>
                        }
                    </select>
                </div>

                <div class="row mb-3">
                    <div class="col-3">
                        <label class="form-label">Method</label>
                        <select class="form-select" @bind="_method">
                            <option>GET</option>
                            <option>POST</option>
                            <option>PUT</option>
                            <option>PATCH</option>
                            <option>DELETE</option>
                        </select>
                    </div>
                    <div class="col-9">
                        <label class="form-label">Endpoint</label>
                        <input type="text" class="form-control" placeholder="/endpoint"
                               @bind="_endpoint" />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Headers (JSON)</label>
                    <textarea class="form-control font-monospace" rows="3"
                              placeholder='{"Content-Type": "application/json"}'
                              @bind="_headers"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Query Parameters (JSON)</label>
                    <textarea class="form-control font-monospace" rows="2"
                              placeholder='{"page": "1", "limit": "10"}'
                              @bind="_queryParams"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Request Body (JSON)</label>
                    <textarea class="form-control font-monospace" rows="6"
                              placeholder='{"key": "value"}'
                              @bind="_body"></textarea>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" @bind="_saveAsDataset" id="saveDataset">
                    <label class="form-check-label" for="saveDataset">
                        Save response as dataset
                    </label>
                </div>

                <button class="btn btn-primary w-100" @onclick="SendRequest" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    <i class="bi bi-send me-1"></i> Send Request
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Response</h5>
                @if (_response != null)
                {
                    <span class="badge @(_response.StatusCode < 400 ? "bg-success" : "bg-danger") fs-6">
                        @_response.StatusCode @_response.DurationMs ms
                    </span>
                }
            </div>
            <div class="card-body">
                @if (_response == null)
                {
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-arrow-left-circle fs-1 d-block mb-2"></i>
                        Send a request to see the response
                    </div>
                }
                else
                {
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#bodyTab">Body</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#headersTab">Headers</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3">
                        <div class="tab-pane fade show active" id="bodyTab">
                            <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow: auto;">@FormatJson(_response.Body)</pre>
                        </div>
                        <div class="tab-pane fade" id="headersTab">
                            <pre class="bg-light p-3 rounded">@FormatHeaders(_response.Headers)</pre>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string _selectedConnector = "";
    private string _method = "GET";
    private string _endpoint = "";
    private string _headers = "";
    private string _body = "";
    private string _queryParams = "";
    private bool _saveAsDataset = false;
    private bool _isLoading = false;
    private bool _fromTemplate = false;
    private ResponseViewModel? _response;

    private List<ConnectorOption> _connectors = new()
    {
        new("1", "JSONPlaceholder"),
        new("2", "Swagger Petstore"),
        new("3", "ReqRes"),
        new("4", "GitHub API"),
        new("5", "OpenWeather")
    };

    protected override void OnInitialized()
    {
        // Subscribe to state changes
        ApiRunnerState.OnChange += HandleStateChange;

        // Check if there's a pending template
        if (ApiRunnerState.HasPendingTemplate)
        {
            LoadFromTemplate();
        }
    }

    private void HandleStateChange()
    {
        if (ApiRunnerState.HasPendingTemplate)
        {
            LoadFromTemplate();
            InvokeAsync(StateHasChanged);
        }
    }

    private void LoadFromTemplate()
    {
        _selectedConnector = ApiRunnerState.SelectedConnectorId ?? "";
        _method = ApiRunnerState.Method ?? "GET";
        _endpoint = ApiRunnerState.Endpoint ?? "";
        _headers = ApiRunnerState.Headers ?? "";
        _body = ApiRunnerState.Body ?? "";
        _queryParams = ApiRunnerState.QueryParams ?? "";
        _fromTemplate = true;
        ApiRunnerState.ClearPendingTemplate();
    }

    public void Dispose()
    {
        ApiRunnerState.OnChange -= HandleStateChange;
    }

    private void DismissTemplateAlert()
    {
        _fromTemplate = false;
    }

    private async Task SendRequest()
    {
        _isLoading = true;
        _response = null;
        await Task.Delay(500); // Simulate API call

        _response = new ResponseViewModel(
            200,
            "{\n  \"userId\": 1,\n  \"id\": 1,\n  \"title\": \"Sample Response\",\n  \"completed\": false\n}",
            new Dictionary<string, string>
            {
                ["Content-Type"] = "application/json",
                ["X-Powered-By"] = "ApiHub"
            },
            145
        );

        _isLoading = false;
    }

    private string FormatJson(string json)
    {
        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true
            });
        }
        catch
        {
            return json;
        }
    }

    private string FormatHeaders(Dictionary<string, string> headers)
    {
        return string.Join("\n", headers.Select(h => $"{h.Key}: {h.Value}"));
    }

    private record ConnectorOption(string Id, string Name);
    private record ResponseViewModel(int StatusCode, string Body, Dictionary<string, string> Headers, int DurationMs);
}
